package main

import (
"log"
"net/http"
"time"

"github.com/gin-contrib/cors"
"github.com/gin-gonic/gin"
)

// AppVersion represents app version and update information
type AppVersion struct {
LatestVersion     string   `json:"latest_version"`
LatestVersionCode int      `json:"latest_version_code"`
MinimumVersionCode int     `json:"minimum_version_code"`
ForceUpdate       bool     `json:"force_update"`
UpdateTitle       string   `json:"update_title"`
UpdateMessage     string   `json:"update_message"`
DownloadURL       string   `json:"download_url"`
WhatsNew          []string `json:"whats_new"`
ReleaseDate       string   `json:"release_date"`
}

// InAppMessage represents an in-app announcement/message
type InAppMessage struct {
ID          string `json:"id"`
Type        string `json:"type"`
Title       string `json:"title"`
Message     string `json:"message"`
ImageURL    string `json:"image_url,omitempty"`
ActionText  string `json:"action_text,omitempty"`
ActionURL   string `json:"action_url,omitempty"`
Priority    int    `json:"priority"`
StartDate   string `json:"start_date"`
EndDate     string `json:"end_date"`
ShowOnce    bool   `json:"show_once"`
Dismissible bool   `json:"dismissible"`
}

// AppConfig is the complete configuration response
type AppConfig struct {
AppVersion     AppVersion     `json:"app_version"`
InAppMessages  []InAppMessage `json:"in_app_messages"`
}

var currentConfig = AppConfig{
AppVersion: AppVersion{
LatestVersion:      "1.5.0",
LatestVersionCode:  150,
MinimumVersionCode: 100,
ForceUpdate:        false,
UpdateTitle:        "üéâ New Update Available!",
UpdateMessage:      "We've added exciting new features and improvements to enhance your experience!",
DownloadURL:        "https://github.com/Lainlain/burma2daio/releases/latest",
WhatsNew: []string{
"‚ú® Brand new App Config & In-App Message system",
"üí¨ Real-time chat with auto-reconnect",
"üéÅ Interactive gift system with native ads",
"üì∞ Paper/News section with beautiful UI",
"üì∫ Interstitial ads on all button clicks",
"üêõ Performance improvements and bug fixes",
},
ReleaseDate: time.Now().Format("2006-01-02"),
},
InAppMessages: []InAppMessage{
{
ID:          "welcome_2025",
Type:        "info",
Title:       "üéä Welcome to Burma 2D 2025!",
Message:     "Thank you for using our app! We're committed to providing you with the best lottery experience. Check out our new features and enjoy real-time updates!",
ImageURL:    "",
ActionText:  "",
ActionURL:   "",
Priority:    5,
StartDate:   "2025-11-01",
EndDate:     "2025-12-31",
ShowOnce:    true,
Dismissible: true,
},
{
ID:          "promo_nov_2025",
Type:        "promo",
Title:       "üéÅ Special November Offer!",
Message:     "Get access to premium features this month! Exclusive analysis, predictions, and more. Don't miss out on this limited-time offer!",
ImageURL:    "",
ActionText:  "Learn More",
ActionURL:   "http://localhost:4545",
Priority:    10,
StartDate:   "2025-11-01",
EndDate:     "2025-11-30",
ShowOnce:    false,
Dismissible: true,
},
{
ID:          "maintenance_alert",
Type:        "warning",
Title:       "‚ö†Ô∏è Scheduled Maintenance",
Message:     "We'll be performing system maintenance on November 10th from 2:00 AM to 4:00 AM. The app may be temporarily unavailable during this time.",
ImageURL:    "",
ActionText:  "",
ActionURL:   "",
Priority:    8,
StartDate:   "2025-11-04",
EndDate:     "2025-11-10",
ShowOnce:    false,
Dismissible: true,
},
},
}

// GetAppConfigHandler returns the current app configuration
func GetAppConfigHandler(c *gin.Context) {
c.JSON(http.StatusOK, currentConfig)
log.Println("‚úÖ App config sent to client")
}

// UpdateAppConfigHandler allows updating the configuration
func UpdateAppConfigHandler(c *gin.Context) {
var newConfig AppConfig
if err := c.ShouldBindJSON(&newConfig); err != nil {
c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
return
}

currentConfig = newConfig
c.JSON(http.StatusOK, gin.H{
"message": "Configuration updated successfully",
"config":  currentConfig,
})
log.Println("‚úÖ App config updated")
}

// GetAppVersionHandler returns only version information
func GetAppVersionHandler(c *gin.Context) {
c.JSON(http.StatusOK, currentConfig.AppVersion)
log.Println("‚úÖ App version info sent")
}

// GetInAppMessagesHandler returns only active messages
func GetInAppMessagesHandler(c *gin.Context) {
c.JSON(http.StatusOK, currentConfig.InAppMessages)
log.Println("‚úÖ In-app messages sent")
}

func main() {
gin.SetMode(gin.ReleaseMode)
r := gin.Default()

r.Use(cors.New(cors.Config{
AllowOrigins:     []string{"*"},
AllowMethods:     []string{"GET", "POST", "PUT", "DELETE", "OPTIONS"},
AllowHeaders:     []string{"Origin", "Content-Type", "Accept", "Authorization"},
ExposeHeaders:    []string{"Content-Length"},
AllowCredentials: true,
MaxAge:           12 * time.Hour,
}))

api := r.Group("/api/burma2d")
{
api.GET("/config", GetAppConfigHandler)
api.GET("/version", GetAppVersionHandler)
api.GET("/messages", GetInAppMessagesHandler)
api.POST("/config", UpdateAppConfigHandler)
}

r.GET("/health", func(c *gin.Context) {
c.JSON(http.StatusOK, gin.H{
"status": "healthy",
"time":   time.Now().Format(time.RFC3339),
})
})

r.GET("/", func(c *gin.Context) {
c.JSON(http.StatusOK, gin.H{
"name":    "Burma 2D - App Config Server",
"version": "1.0.0",
"status":  "running",
"endpoints": []string{
"GET  /api/burma2d/config   - Get full app configuration",
"GET  /api/burma2d/version  - Get version info only",
"GET  /api/burma2d/messages - Get in-app messages only",
"POST /api/burma2d/config   - Update configuration (admin)",
"GET  /health               - Health check",
},
})
})

port := "8080"
log.Printf("üöÄ Burma 2D App Config Server starting on port %s...\n", port)
log.Printf("üì° Main endpoint: http://localhost:%s/api/burma2d/config\n", port)
log.Printf("üè• Health check:  http://localhost:%s/health\n", port)
log.Println("‚úÖ Server ready to serve app configuration!")

if err := r.Run(":" + port); err != nil {
log.Fatal("‚ùå Failed to start server: ", err)
}
}
